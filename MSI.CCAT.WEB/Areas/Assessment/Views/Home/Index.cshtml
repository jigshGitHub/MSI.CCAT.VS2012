@{
    ViewBag.Title = "Index";
}

@Html.Hidden("userId", (string)(@ViewBag.UserID))
<table>
    <tbody data-bind="foreach: questions">
        <tr>
            <td data-bind="text: serialNumber"></td>
            <td>
                <select data-bind="options: responses, optionsValue: 'Value', optionsCaption: ' ', optionsText: 'Value', value: response">
                </select>
            </td>
            <td data-bind="text: text"></td>
        </tr>
    </tbody>
</table>
<input type="button" data-bind="click: previousClick, visible: previousVisible" value="Previous" />&nbsp;<input type="button" data-bind="    click: nextClick, visible: nextVisible" value="Next" />

@section scripts{
    <script type="text/javascript">
        var answerOptions = [{ Text: 'Not Compliant', Value: '0' }, { Text: 'Unsure', Value: '1' }, { Text: 'Slightly Agree', Value: '2' }, { Text: 'Agree', Value: '3' }, { Text: 'Strongly Agree', Value: '4' }, { Text: 'Fully Compliant', Value: '5' }];
        var questionResponse = function (_id, _text, _srNo, _response, _responseId) {
            var self = this;
            self.id = ko.observable(_id);
            self.response = ko.observable(_response);
            self.responses = ko.observableArray(answerOptions);
            self.text = ko.observable(_text);
            self.serialNumber = ko.observable(_srNo);
            self.responseId = ko.observable(_responseId);
            self.response.subscribe(function (responseSelected) {
                if (responseSelected != '' || responsese != undefined) {
                    alert(responseSelected);
                }
            });
        }
        var questionModule = function (_id, _name) {
            var self = this;
            self.id = ko.observable(_id);
            self.name = ko.observable(_name);
        }

        var pageViewModel = function (userId) {
            var self = this;
            self.userId = userId;
            self.modules = ko.observableArray([]);
            self.totalQuestionCount = ko.observable();;
            self.questionsDisplayCount = 10;
            self.questionsDisplayStartIndex = ko.observable(0);
            self.questionsDisplayEndIndex = ko.observable(self.questionsDisplayCount);
            self.questionsCollection = ko.observableArray([]);
            self.questions = ko.computed(function () {
                return self.questionsCollection.slice(self.questionsDisplayStartIndex(), self.questionsDisplayEndIndex());
            }, self);

            self.nextClick = function () {
                self.questionsDisplayStartIndex(self.questionsDisplayStartIndex()+self.questionsDisplayCount);
                self.questionsDisplayEndIndex(self.questionsDisplayEndIndex() + self.questionsDisplayCount);
            };

            self.nextVisible = ko.computed(function () {
                return (self.questionsDisplayEndIndex() <= self.totalQuestionCount());
            }, self);

            self.previousClick = function () {
                self.questionsDisplayStartIndex(self.questionsDisplayStartIndex() - self.questionsDisplayCount);
                self.questionsDisplayEndIndex(self.questionsDisplayEndIndex() - self.questionsDisplayCount);
            };

            self.previousVisible = ko.computed(function () {
                return (self.questionsDisplayStartIndex() > 0 && self.questionsDisplayStartIndex() <= self.totalQuestionCount());
            }, self);

            self.selectedModule = ko.computed(function () { return self.modules[0]; }, self);
            
            self.loadModules = function () {
                self.modules.push(new questionModule(1, 'Entity Business Model'));
            }

            self.loadQuestions = function () {
                $.ajax({
                    url: '/api/Assessment',
                    type: 'GET',
                    contentType: 'application/json',
                    data: { moduleId: 1 , userId: userId},
                    dataType: 'json',
                    async: false,
                    success: function (data) {
                        self.totalQuestionCount(data.length);
                        if (data.length > 0) {
                            $.each(data, function (i, item) {
                                self.questionsCollection.push(new questionResponse(item.QuestionId, item.Question, item.SerialNumber, item.Response, item.ResponseId));
                            });
                        }
                    },
                    error: function (xhr, status, somthing) {
                        log(status);
                    }
                });
            };
        }

        $(document).ready(function () {


            var vm = new pageViewModel($('#userId').val());
            vm.loadQuestions();

            ko.applyBindings(vm);


        });
    </script>
}

<h2>Index</h2>
